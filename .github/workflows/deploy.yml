name: ğŸŒ¾ Deploy TelAgri Bank Dashboard

# This workflow:
# - On PULL REQUEST: Only runs build, lint, test, and security scan (no deployment)
# - On PUSH (merge): Runs full pipeline including deployment to AWS  
# - On MANUAL: Allows manual deployment to any environment

on:
  push:
    branches:
      - main
      - dev
      - staging
  pull_request:
    branches:
      - main
      - dev
      - staging
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  # Build and test the frontend
  build:
    name: ğŸ—ï¸ Build PWA
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ” Lint code
        run: npm run lint

      - name: ğŸ—ï¸ Build PWA
        run: npm run build

      - name: ğŸ“Š Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 7

  # Determine deployment environment
  environment:
    name: ğŸ¯ Determine Environment
    runs-on: ubuntu-latest
    outputs:
      env: ${{ steps.env.outputs.env }}
      domain: ${{ steps.env.outputs.domain }}
    
    steps:
      - name: ğŸ¯ Set environment
        id: env
        run: |
          if [ "${{ github.event.inputs.environment }}" != "" ]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            ENV="prod"
          elif [ "${{ github.ref }}" = "refs/heads/staging" ]; then
            ENV="staging"
          elif [ "${{ github.ref }}" = "refs/heads/dev" ]; then
            ENV="dev"
          else
            ENV="dev"
          fi
          
          echo "env=${ENV}" >> $GITHUB_OUTPUT
          
          case ${ENV} in
            prod)
              echo "domain=dashboard.telagri.com" >> $GITHUB_OUTPUT
              ;;
            staging)
              echo "domain=dashboard-dev.telagri.com" >> $GITHUB_OUTPUT
              ;;
            dev)
              echo "domain=dashboard-stg.telagri.com" >> $GITHUB_OUTPUT
              ;;
          esac
          
          echo "ğŸ¯ Deploying to: ${ENV}"
          echo "ğŸŒ Domain: $(cat $GITHUB_OUTPUT | grep domain | cut -d= -f2)"

  # Run database migrations
  migrate:
    name: ğŸ—„ï¸ Run DB Migrations
    runs-on: ubuntu-latest
    needs: [build, environment]
    environment: ${{ needs.environment.outputs.env }}
    # Only run migrations on push events (when PRs are merged), not on pull_request events
    if: github.event_name != 'pull_request'
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ”§ Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: ğŸ—„ï¸ Run database migrations (Direct URL method)
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
        run: |
          echo "ğŸ—„ï¸ Running database migrations using direct URL method..."
          echo "Project ID: $SUPABASE_PROJECT_ID"
          echo "Access Token: ${SUPABASE_ACCESS_TOKEN:+Set}${SUPABASE_ACCESS_TOKEN:-Not Set}"
          echo "DB Password: ${SUPABASE_DB_PASSWORD:+Set}${SUPABASE_DB_PASSWORD:-Not Set}"
          
          if [ -z "$SUPABASE_DB_PASSWORD" ]; then
            echo "âŒ SUPABASE_DB_PASSWORD is not set!"
            echo "Please add SUPABASE_DB_PASSWORD to GitHub repository secrets"
            exit 1
          fi
          
          # Construct database URL - using pooled connection for better CI/CD compatibility
          # Direct connection (db.*.supabase.co:5432) has IPv6 connectivity issues in GitHub Actions
          DB_URL="postgresql://postgres.${SUPABASE_PROJECT_ID}:${SUPABASE_DB_PASSWORD}@aws-1-us-east-2.pooler.supabase.com:6543/postgres"
          echo "ğŸ”— Using pooled database URL connection for CI/CD compatibility..."
          
          # Run migrations using direct URL with retry logic
          echo "ğŸ“‹ Checking current migration status..."
          
          # Retry function for database operations
          retry_command() {
            local cmd="$1"
            local max_attempts=3
            local attempt=1
            
            while [ $attempt -le $max_attempts ]; do
              echo "Attempt $attempt/$max_attempts: $cmd"
              
              # Capture both stdout and stderr
              local output
              if output=$(eval "$cmd" 2>&1); then
                echo "âœ… Command succeeded on attempt $attempt"
                echo "$output"
                return 0
              else
                echo "âŒ Command failed on attempt $attempt"
                echo "$output"
                
                # Check for specific "up to date" messages
                if echo "$output" | grep -q "Remote database is up to date"; then
                  echo "âœ… Database is already up to date - treating as success"
                  return 0
                fi
                
                # Check for prepared statement errors that might indicate up-to-date database
                if echo "$output" | grep -q "prepared statement.*already exists"; then
                  echo "âš ï¸ Prepared statement conflict detected"
                  # For db push commands, this typically means database is already up to date
                  if echo "$cmd" | grep -q "db push"; then
                    echo "âœ… Database is already up to date - treating prepared statement conflict as success"
                    return 0
                  # For migration list commands, also treat as success since connection is working
                  elif echo "$cmd" | grep -q "migration list"; then
                    echo "âœ… Migration list connection works despite prepared statement conflict - treating as success"
                    return 0
                  else
                    echo "âš ï¸ Prepared statement conflict in other command - continuing retry..."
                  fi
                fi
                
                if [ $attempt -eq $max_attempts ]; then
                  echo "ğŸš¨ All attempts failed"
                  return 1
                fi
                echo "â³ Waiting 5 seconds before retry..."
                sleep 5
                attempt=$((attempt + 1))
              fi
            done
          }
          
          # Check migration status with retry
          # Check migration status with retry
          retry_command "supabase migration list --db-url '$DB_URL'"
          
          echo "ğŸš€ Applying new migrations..."
          retry_command "supabase db push --db-url '$DB_URL'"
          
          echo "âœ… Migrations completed successfully!"
          
          echo "ğŸ“Š Final migration status:"
          retry_command "supabase migration list --db-url '$DB_URL'"

  # Deploy infrastructure with CDK
  deploy:
    name: ğŸš€ Deploy to AWS
    runs-on: ubuntu-latest
    needs: [build, environment, migrate]
    environment: ${{ needs.environment.outputs.env }}
    # Only deploy on push events (when PRs are merged), not on pull_request events
    if: github.event_name != 'pull_request'
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“Š Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            cdk/package-lock.json

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: âš™ï¸ Configure AWS credentials (Access Keys)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}

      - name: ğŸ“¦ Install CDK dependencies
        working-directory: cdk
        run: npm ci

      - name: ğŸ—ï¸ Build CDK
        working-directory: cdk
        run: npm run build

      - name: ğŸ” CDK Diff
        working-directory: cdk
        env:
          ENVIRONMENT: ${{ needs.environment.outputs.env }}
          DOMAIN_NAME: ${{ needs.environment.outputs.domain }}
          CERTIFICATE_ARN: ${{ vars.CERTIFICATE_ARN }}
          AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
        run: |
          echo "ğŸ” Showing infrastructure changes..."
          npm run diff || true

      - name: ğŸš€ Deploy CDK Stack
        working-directory: cdk
        env:
          ENVIRONMENT: ${{ needs.environment.outputs.env }}
          DOMAIN_NAME: ${{ needs.environment.outputs.domain }}
          CERTIFICATE_ARN: ${{ vars.CERTIFICATE_ARN }}
          AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
        run: |
          echo "ğŸš€ Deploying TelAgri Bank Dashboard to ${{ needs.environment.outputs.env }}..."
          npm run deploy

      - name: ğŸ“‹ Get Stack Outputs
        working-directory: cdk
        env:
          ENVIRONMENT: ${{ needs.environment.outputs.env }}
        run: |
          echo "ğŸ“‹ Stack Outputs:"
          aws cloudformation describe-stacks \
            --stack-name "TelAgri-Bank-Dashboard-${{ needs.environment.outputs.env }}" \
            --query 'Stacks[0].Outputs' \
            --output table || true

      - name: âœ… Deployment Success
        run: |
          echo "ğŸ‰ TelAgri Bank Dashboard successfully deployed!"
          echo "ğŸŒ URL: https://${{ needs.environment.outputs.domain }}"
          echo "ğŸ”§ Environment: ${{ needs.environment.outputs.env }}"
          echo "ğŸ“Š Build: ${{ github.sha }}"

  # Security scan (runs on all events)
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: [build]
    # Run security scan on all PRs and main branch pushes
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    permissions:
      security-events: write
      actions: read
      contents: read
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”’ Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          output: 'trivy-results.txt'

      - name: ğŸ“Š Display security scan results
        if: always()
        run: |
          echo "ğŸ”’ Security Scan Results:"
          echo "========================"
          if [ -f trivy-results.txt ]; then
            cat trivy-results.txt
          else
            echo "âœ… No vulnerabilities detected or scan output not generated"
          fi
          echo "========================"

  # Notification (only for deployments)
  notify:
    name: ğŸ“¢ Notify
    runs-on: ubuntu-latest
    needs: [migrate, deploy, environment]
    # Only notify on deployment attempts (not PRs), and always run regardless of deploy success/failure
    if: always() && github.event_name != 'pull_request'
    
    steps:
      - name: ğŸ“¢ Deployment notification
        run: |
          echo "ğŸ“Š Deployment Summary:"
          echo "====================="
          echo "ğŸ—„ï¸ Migrations: ${{ needs.migrate.result }}"
          echo "ğŸš€ Deployment: ${{ needs.deploy.result }}"
          echo "ğŸŒ Environment: ${{ needs.environment.outputs.env }}"
          echo ""
          
          if [ "${{ needs.migrate.result }}" == "success" ] && [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… TelAgri Bank Dashboard deployment fully successful!"
            echo "ğŸ”— URL: https://${{ needs.environment.outputs.domain }}"
          elif [ "${{ needs.migrate.result }}" == "failure" ]; then
            echo "âŒ Database migration failed!"
            echo "ğŸš¨ Deployment was skipped due to migration failure"
            echo "ğŸ“‹ Check migration logs for details"
          elif [ "${{ needs.deploy.result }}" == "failure" ]; then
            echo "âŒ AWS deployment failed!"
            echo "âœ… Database migrations completed successfully"
            echo "ğŸ“‹ Check deployment logs for details"
          else
            echo "âŒ Deployment pipeline failed!"
            echo "ğŸ“‹ Check the logs for details"
          fi 