name: ğŸŒ¾ Deploy TelAgri Bank Dashboard

# This workflow:
# - On PULL REQUEST: Only runs build, lint, test, and security scan (no deployment)
# - On PUSH (merge): Runs full pipeline including deployment to AWS  
# - On MANUAL: Allows manual deployment to any environment (dev, staging, prod)

on:
  push:
    branches:
      - main
      - dev
      - staging
  pull_request:
    branches:
      - main
      - dev
      - staging
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # Build and test the frontend
  build:
    name: ğŸ—ï¸ Build PWA
    runs-on: ubuntu-latest
    needs: [environment]
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: âš™ï¸ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/telagri-github-actions-role-${{ needs.environment.outputs.env }}
          role-session-name: telagri-build-session
          aws-region: ${{ needs.environment.outputs.region }}

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ” Lint code
        run: npm run lint

      - name: ğŸ”§ Fetch Environment Configuration from AWS
        env:
          ENVIRONMENT: ${{ needs.environment.outputs.env }}
          AWS_REGION: ${{ needs.environment.outputs.region }}
        run: |
          echo "ğŸ”§ Fetching environment configuration from AWS Parameter Store"
          echo "Environment: $ENVIRONMENT"
          echo "Region: $AWS_REGION"
          echo "Parameter Path: /telagri/monitoring/$ENVIRONMENT/frontend/env"
          
          # Make the script executable
          chmod +x scripts/fetch-env-from-aws.sh
          
          # Fetch frontend environment configuration from AWS Parameter Store
          ./scripts/fetch-env-from-aws.sh "$ENVIRONMENT" "$AWS_REGION"
          
          # Validate that .env file was created and contains VITE_ variables
          if [ ! -f ".env" ]; then
            echo "âŒ .env file was not created"
            exit 1
          fi
          
          # Check if .env contains frontend variables
          VITE_COUNT=$(grep -c '^VITE_' .env || echo "0")
          if [ "$VITE_COUNT" -eq 0 ]; then
            echo "âš ï¸ Warning: No VITE_ variables found in .env file"
            echo "ğŸ“‹ .env file contents:"
            cat .env
          else
            echo "âœ… Found $VITE_COUNT frontend variables in .env file"
          fi

      - name: ğŸ—ï¸ Build PWA
        env:
          ENVIRONMENT: ${{ needs.environment.outputs.env }}
        run: |
          echo "ğŸ—ï¸ Building PWA for environment: $ENVIRONMENT"
          npm run build

      - name: ğŸ“Š Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 7

  # Determine deployment environment
  environment:
    name: ğŸ¯ Determine Environment
    runs-on: ubuntu-latest
    outputs:
      env: ${{ steps.env.outputs.env }}
      domain: ${{ steps.env.outputs.domain }}
      region: ${{ steps.env.outputs.region }}
    
    steps:
      - name: ğŸ¯ Set environment
        id: env
        run: |
          if [ "${{ github.event.inputs.environment }}" != "" ]; then
            ENV="${{ github.event.inputs.environment }}"
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            ENV="prod"
          elif [ "${{ github.ref }}" = "refs/heads/staging" ]; then
            ENV="staging"
          elif [ "${{ github.ref }}" = "refs/heads/dev" ]; then
            ENV="dev"
          else
            ENV="dev"
          fi
          
          echo "env=${ENV}" >> $GITHUB_OUTPUT
          
          case ${ENV} in
            prod)
              echo "domain=dashboard.telagri.com" >> $GITHUB_OUTPUT
              ;;
            staging)
              echo "domain=dashboard-stg.telagri.com" >> $GITHUB_OUTPUT
              ;;
            dev)
              echo "domain=dashboard-dev.telagri.com" >> $GITHUB_OUTPUT
              ;;
          esac
          
          # Set AWS region (us-east-1 for all environments)
          echo "region=us-east-1" >> $GITHUB_OUTPUT
          
          echo "ğŸ¯ Deploying to: ${ENV}"
          echo "ğŸŒ Domain: $(cat $GITHUB_OUTPUT | grep domain | cut -d= -f2)"
          echo "ğŸŒ Region: us-east-1"

  # Run database migrations
  migrate:
    name: ğŸ—„ï¸ Run DB Migrations
    runs-on: ubuntu-latest
    needs: [build, environment]
    environment: ${{ needs.environment.outputs.env }}
    # Only run migrations on push events (when PRs are merged), not on pull_request events
    if: github.event_name != 'pull_request'
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      - name: ğŸ”§ Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: ğŸ—„ï¸ Run database migrations
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
        run: |
          echo "ğŸ—„ï¸ Running database migrations using Supabase CLI..."
          
          # Export environment variables for Supabase CLI
          export SUPABASE_ACCESS_TOKEN
          export SUPABASE_DB_PASSWORD  
          export SUPABASE_PROJECT_ID
          
          echo "Project ID: ${SUPABASE_PROJECT_ID:0:3}***"
          echo "Access Token: ${SUPABASE_ACCESS_TOKEN:+Set}${SUPABASE_ACCESS_TOKEN:-Not Set}"
          echo "DB Password: ${SUPABASE_DB_PASSWORD:+Set}${SUPABASE_DB_PASSWORD:-Not Set}"
          
          # Pre-validation: Check credentials
          echo "ğŸ” Pre-validation checks..."
          if [ -z "$SUPABASE_ACCESS_TOKEN" ] || [ -z "$SUPABASE_DB_PASSWORD" ] || [ -z "$SUPABASE_PROJECT_ID" ]; then
            echo "âŒ Missing required environment variables"
            exit 1
          fi
          
          echo "âœ… All required environment variables are set"
          
          # Link project
          echo "ğŸ”— Linking to Supabase project..."
          if supabase link --project-ref "$SUPABASE_PROJECT_ID"; then
            echo "âœ… Project linked successfully"
          else
            echo "âŒ Failed to link project"
            exit 1
          fi
          
          # Pre-migration check
          echo "ğŸ“‹ Pre-migration validation..."
          supabase migration list --linked || echo "âš ï¸ Could not retrieve migration list"
          
          # Apply migrations
          echo "ğŸš€ Applying database migrations..."
          if supabase db push --linked; then
            echo "âœ… Migrations applied successfully"
          else
            echo "âŒ Migration failed"
            echo "ğŸ” Post-failure diagnostics..."
            supabase migration list || echo "Could not retrieve migration status"
            supabase db diff || echo "Could not retrieve database diff"
            exit 1
          fi
          
          # Post-migration validation
          echo "ğŸ“Š Post-migration validation..."
          supabase migration list --linked
          
          if supabase db diff --linked; then
            echo "âš ï¸ Schema differences detected after migration"
          else
            echo "âœ… No schema differences - migrations fully applied"
          fi
          
          echo "âœ… Migration process completed successfully"

  # Deploy infrastructure with CDK
  deploy:
    name: ğŸš€ Deploy to AWS
    runs-on: ubuntu-latest
    needs: [build, environment, migrate]
    environment: ${{ needs.environment.outputs.env }}
    # Only deploy on push events (when PRs are merged), not on pull_request events
    if: github.event_name != 'pull_request'
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ“Š Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            cdk/package-lock.json

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: âš™ï¸ Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/telagri-github-actions-role-${{ needs.environment.outputs.env }}
          role-session-name: telagri-deploy-session
          aws-region: ${{ needs.environment.outputs.region }}

      - name: ğŸ“¦ Install CDK dependencies
        working-directory: cdk
        run: npm ci

      - name: ğŸ—ï¸ Build CDK
        working-directory: cdk
        run: npm run build

      - name: ğŸ” CDK Diff
        working-directory: cdk
        env:
          ENVIRONMENT: ${{ needs.environment.outputs.env }}
          DOMAIN_NAME: ${{ needs.environment.outputs.domain }}
          CERTIFICATE_ARN: ${{ vars.CERTIFICATE_ARN }}
          AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
          AWS_REGION: ${{ needs.environment.outputs.region }}
        run: |
          echo "ğŸ” Showing infrastructure changes..."
          # Ensure bootstrap before diff to avoid warnings
          npx cdk bootstrap aws://$AWS_ACCOUNT_ID/$AWS_REGION --force > /dev/null 2>&1 || true
          npm run diff || true

      - name: ğŸ”§ Ensure CDK Bootstrap
        working-directory: cdk
        env:
          ENVIRONMENT: ${{ needs.environment.outputs.env }}
          AWS_REGION: ${{ needs.environment.outputs.region }}
          AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
        run: |
          echo "ğŸ”§ Ensuring CDK bootstrap is up to date..."
          # Update CDK bootstrap to latest version to fix role assumption warnings
          echo "ğŸ“¦ Updating CDK bootstrap for account $AWS_ACCOUNT_ID in region $AWS_REGION..."
          npx cdk bootstrap aws://$AWS_ACCOUNT_ID/$AWS_REGION --force
          echo "âœ… CDK bootstrap updated successfully"

      - name: ğŸš€ Deploy CDK Stack
        working-directory: cdk
        env:
          ENVIRONMENT: ${{ needs.environment.outputs.env }}
          DOMAIN_NAME: ${{ needs.environment.outputs.domain }}
          CERTIFICATE_ARN: ${{ vars.CERTIFICATE_ARN }}
          AWS_ACCOUNT_ID: ${{ vars.AWS_ACCOUNT_ID }}
        run: |
          echo "ğŸš€ Deploying TelAgri Bank Dashboard to ${{ needs.environment.outputs.env }}..."
          npm run deploy

      - name: ğŸ“‹ Get Stack Outputs
        working-directory: cdk
        env:
          ENVIRONMENT: ${{ needs.environment.outputs.env }}
        run: |
          echo "ğŸ“‹ Stack Outputs:"
          aws cloudformation describe-stacks \
            --stack-name "TelAgri-Bank-Dashboard-${{ needs.environment.outputs.env }}" \
            --query 'Stacks[0].Outputs' \
            --output table || true

      - name: âœ… Deployment Success
        run: |
          echo "ğŸ‰ TelAgri Bank Dashboard successfully deployed!"
          echo "ğŸŒ URL: https://${{ needs.environment.outputs.domain }}"
          echo "ğŸ”§ Environment: ${{ needs.environment.outputs.env }}"
          echo "ğŸ“Š Build: ${{ github.sha }}"

  # Security scan (runs on all events)
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: [build]
    # Run security scan on all PRs and main branch pushes
    if: github.event_name == 'pull_request' || github.ref == 'refs/heads/main'
    permissions:
      security-events: write
      actions: read
      contents: read
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”’ Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          output: 'trivy-results.txt'

      - name: ğŸ“Š Display security scan results
        if: always()
        run: |
          echo "ğŸ”’ Security Scan Results:"
          echo "========================"
          if [ -f trivy-results.txt ]; then
            cat trivy-results.txt
          else
            echo "âœ… No vulnerabilities detected or scan output not generated"
          fi
          echo "========================"

  # Notification (only for deployments)
  notify:
    name: ğŸ“¢ Notify
    runs-on: ubuntu-latest
    needs: [migrate, deploy, environment]
    # Only notify on deployment attempts (not PRs), and always run regardless of deploy success/failure
    if: always() && github.event_name != 'pull_request'
    
    steps:
      - name: ğŸ“¢ Deployment notification
        run: |
          echo "ğŸ“Š Deployment Summary:"
          echo "====================="
          echo "ğŸ—„ï¸ Migrations: ${{ needs.migrate.result }}"
          echo "ğŸš€ Deployment: ${{ needs.deploy.result }}"
          echo "ğŸŒ Environment: ${{ needs.environment.outputs.env }}"
          echo ""
          
          if [ "${{ needs.migrate.result }}" == "success" ] && [ "${{ needs.deploy.result }}" == "success" ]; then
            echo "âœ… TelAgri Bank Dashboard deployment fully successful!"
            echo "ğŸ”— URL: https://${{ needs.environment.outputs.domain }}"
          elif [ "${{ needs.migrate.result }}" == "failure" ]; then
            echo "âŒ Database migration failed!"
            echo "ğŸš¨ Deployment was skipped due to migration failure"
            echo "ğŸ“‹ Check migration logs for details"
          elif [ "${{ needs.deploy.result }}" == "failure" ]; then
            echo "âŒ AWS deployment failed!"
            echo "âœ… Database migrations completed successfully"
            echo "ğŸ“‹ Check deployment logs for details"
          else
            echo "âŒ Deployment pipeline failed!"
            echo "ğŸ“‹ Check the logs for details"
          fi 